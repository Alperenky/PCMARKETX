<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sipariş Düzenle - PC MARKET X Admin Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/admin.css">
</head>
<body>
    <div class="admin-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <i class="fas fa-desktop"></i>
                    <span>PC MARKET X</span>
                </div>
                <button class="sidebar-toggle">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
            <div class="sidebar-user">
                <div class="sidebar-user-avatar">A</div>
                <div class="sidebar-user-info">
                    <div class="sidebar-user-name">Admin</div>
                    <div class="sidebar-user-role">Yönetici</div>
                </div>
            </div>
            <div class="sidebar-nav">
                <a href="index.html" class="sidebar-nav-item">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </a>
                <a href="products.html" class="sidebar-nav-item">
                    <i class="fas fa-box"></i>
                    <span>Ürünler</span>
                </a>
                <a href="orders.html" class="sidebar-nav-item active">
                    <i class="fas fa-shopping-cart"></i>
                    <span>Siparişler</span>
                </a>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <h1 class="header-title">Sipariş Düzenle</h1>
                <div class="header-actions">
                    <button id="backToOrders" class="btn btn-light">
                        <i class="fas fa-arrow-left"></i> Siparişlere Dön
                    </button>
                    <button id="saveOrder" class="btn btn-primary">
                        <i class="fas fa-save"></i> Kaydet
                    </button>
                </div>
            </div>
            
            <!-- Order Info Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Sipariş Bilgileri</div>
                </div>
                <div class="card-body">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Sipariş Numarası</label>
                            <input type="text" id="orderNumber" class="form-control" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Oluşturma Tarihi</label>
                            <input type="text" id="orderDate" class="form-control" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Müşteri</label>
                            <input type="text" id="customerName" class="form-control" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">E-posta</label>
                            <input type="text" id="customerEmail" class="form-control" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Durum</label>
                            <select id="orderStatus" class="form-select">
                                <option value="PENDING">Beklemede</option>
                                <option value="PROCESSING">İşleniyor</option>
                                <option value="SHIPPED">Kargoya Verildi</option>
                                <option value="DELIVERED">Teslim Edildi</option>
                                <option value="CANCELED">İptal Edildi</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Ödeme Durumu</label>
                            <select id="isPaid" class="form-select">
                                <option value="false">Ödenmedi</option>
                                <option value="true">Ödendi</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Ödeme Yöntemi</label>
                            <select id="paymentMethod" class="form-select">
                                <option value="Kredi Kartı">Kredi Kartı</option>
                                <option value="Havale/EFT">Havale/EFT</option>
                                <option value="Kapıda Ödeme">Kapıda Ödeme</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Address Card -->
            <div class="row">
                <div class="col-6">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Teslimat Adresi</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Adres</label>
                                <input type="text" id="shippingAddress" class="form-control">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Şehir</label>
                                <input type="text" id="shippingCity" class="form-control">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Posta Kodu</label>
                                <input type="text" id="shippingPostalCode" class="form-control">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Ülke</label>
                                <input type="text" id="shippingCountry" class="form-control">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Faturalama Adresi</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Adres</label>
                                <input type="text" id="billingAddress" class="form-control">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Şehir</label>
                                <input type="text" id="billingCity" class="form-control">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Posta Kodu</label>
                                <input type="text" id="billingPostalCode" class="form-control">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Ülke</label>
                                <input type="text" id="billingCountry" class="form-control">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Order Items Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Sipariş Ürünleri</div>
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table class="table" id="orderItemsTable">
                            <thead>
                                <tr>
                                    <th>Ürün</th>
                                    <th>Birim Fiyat</th>
                                    <th>Miktar</th>
                                    <th>Toplam</th>
                                </tr>
                            </thead>
                            <tbody id="orderItemsList">
                                <!-- Sipariş ürünleri burada listelenecek -->
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="3" style="text-align: right;"><strong>Ara Toplam:</strong></td>
                                    <td id="orderSubtotal"></td>
                                </tr>
                                <tr>
                                    <td colspan="3" style="text-align: right;"><strong>Vergiler:</strong></td>
                                    <td>
                                        <input type="number" id="taxPrice" class="form-control form-control-sm" step="0.01">
                                    </td>
                                </tr>
                                <tr>
                                    <td colspan="3" style="text-align: right;"><strong>Kargo:</strong></td>
                                    <td>
                                        <input type="number" id="shippingPrice" class="form-control form-control-sm" step="0.01">
                                    </td>
                                </tr>
                                <tr>
                                    <td colspan="3" style="text-align: right;"><strong>Toplam:</strong></td>
                                    <td id="orderTotal"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="notification-container"></div>
    
    <script src="js/admin.js"></script>
    <script src="js/admin-api.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Sipariş ID'sini URL'den al
            const urlParams = new URLSearchParams(window.location.search);
            const orderId = urlParams.get('id');
            
            if (!orderId) {
                showNotification('Sipariş ID bulunamadı', 'error');
                setTimeout(() => {
                    window.location.href = 'orders.html';
                }, 2000);
                return;
            }
            
            // Geri dönüş butonu
            document.getElementById('backToOrders').addEventListener('click', function() {
                window.location.href = 'orders.html';
            });
            
            // Kaydet butonu
            document.getElementById('saveOrder').addEventListener('click', function() {
                saveOrderChanges(orderId);
            });
            
            // Sipariş detaylarını yükle
            loadOrderDetails(orderId);
            
            // Vergi ve kargo ücretlerinin değişimini dinle
            document.getElementById('taxPrice').addEventListener('change', updateTotal);
            document.getElementById('shippingPrice').addEventListener('change', updateTotal);
        });
        
        // Sipariş detaylarını yükle
        async function loadOrderDetails(orderId) {
            try {
                showLoading();
                
                // Siparişi getir
                const order = await AdminAPI.getOrderById(orderId);
                console.log('Sipariş detayları:', order);
                
                // Form alanlarını doldur
                document.getElementById('orderNumber').value = order.orderNumber || order._id;
                document.getElementById('orderDate').value = formatDate(order.createdAt);
                document.getElementById('orderStatus').value = order.status;
                document.getElementById('isPaid').value = order.isPaid ? 'true' : 'false';
                document.getElementById('paymentMethod').value = order.paymentMethod || 'Kredi Kartı';
                
                // Müşteri bilgileri
                if (order.user) {
                    document.getElementById('customerName').value = order.user.username || '';
                    document.getElementById('customerEmail').value = order.user.email || '';
                }
                
                // Teslimat adresi
                if (order.shippingAddress) {
                    document.getElementById('shippingAddress').value = order.shippingAddress.address || '';
                    document.getElementById('shippingCity').value = order.shippingAddress.city || '';
                    document.getElementById('shippingPostalCode').value = order.shippingAddress.postalCode || '';
                    document.getElementById('shippingCountry').value = order.shippingAddress.country || '';
                }
                
                // Fatura adresi (varsa)
                if (order.billingAddress) {
                    document.getElementById('billingAddress').value = order.billingAddress.address || '';
                    document.getElementById('billingCity').value = order.billingAddress.city || '';
                    document.getElementById('billingPostalCode').value = order.billingAddress.postalCode || '';
                    document.getElementById('billingCountry').value = order.billingAddress.country || '';
                } else if (order.shippingAddress) {
                    // Fatura adresi yoksa teslimat adresini kullan
                    document.getElementById('billingAddress').value = order.shippingAddress.address || '';
                    document.getElementById('billingCity').value = order.shippingAddress.city || '';
                    document.getElementById('billingPostalCode').value = order.shippingAddress.postalCode || '';
                    document.getElementById('billingCountry').value = order.shippingAddress.country || '';
                }
                
                // Sipariş ürünleri
                renderOrderItems(order.orderItems || []);
                
                // Toplam bilgileri
                document.getElementById('taxPrice').value = order.taxPrice || 0;
                document.getElementById('shippingPrice').value = order.shippingPrice || 0;
                
                updateTotal();
                
            } catch (error) {
                console.error('Sipariş detayları yüklenirken hata:', error);
                showNotification('Sipariş detayları yüklenirken bir hata oluştu', 'error');
            } finally {
                hideLoading();
            }
        }
        
        // Sipariş ürünlerini tabloya ekle
        function renderOrderItems(items) {
            const tableBody = document.getElementById('orderItemsList');
            tableBody.innerHTML = '';
            
            let subtotal = 0;
            
            items.forEach((item, index) => {
                const itemTotal = item.price * item.qty;
                subtotal += itemTotal;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 50px; height: 50px; overflow: hidden; border-radius: 4px;">
                                <img src="${item.image || '../img/product-placeholder.png'}" alt="${item.name}" style="width: 100%; height: 100%; object-fit: cover;">
                            </div>
                            <div>
                                <div style="font-weight: 500;">${item.name}</div>
                                <div style="color: #666; font-size: 0.8rem;">${item.product}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <input type="number" class="form-control form-control-sm item-price" data-index="${index}" value="${item.price}" step="0.01">
                    </td>
                    <td>
                        <input type="number" class="form-control form-control-sm item-qty" data-index="${index}" value="${item.qty}" min="1">
                    </td>
                    <td class="item-total">${formatPrice(itemTotal)}</td>
                `;
                
                tableBody.appendChild(row);
            });
            
            document.getElementById('orderSubtotal').textContent = formatPrice(subtotal);
            
            // Ürün fiyat ve miktarlarının değişimini dinle
            document.querySelectorAll('.item-price, .item-qty').forEach(input => {
                input.addEventListener('change', function() {
                    updateItemTotals();
                });
            });
        }
        
        // Ürün satır toplamlarını güncelle
        function updateItemTotals() {
            const prices = document.querySelectorAll('.item-price');
            const quantities = document.querySelectorAll('.item-qty');
            const totals = document.querySelectorAll('.item-total');
            
            let subtotal = 0;
            
            for (let i = 0; i < prices.length; i++) {
                const price = parseFloat(prices[i].value);
                const qty = parseInt(quantities[i].value);
                const total = price * qty;
                
                totals[i].textContent = formatPrice(total);
                subtotal += total;
            }
            
            document.getElementById('orderSubtotal').textContent = formatPrice(subtotal);
            updateTotal();
        }
        
        // Sipariş toplamını güncelle
        function updateTotal() {
            const subtotalText = document.getElementById('orderSubtotal').textContent;
            const subtotal = parseFloat(subtotalText.replace(/[^0-9.]/g, ''));
            
            const taxPrice = parseFloat(document.getElementById('taxPrice').value) || 0;
            const shippingPrice = parseFloat(document.getElementById('shippingPrice').value) || 0;
            
            const total = subtotal + taxPrice + shippingPrice;
            document.getElementById('orderTotal').textContent = formatPrice(total);
        }
        
        // Sipariş değişikliklerini kaydet
        async function saveOrderChanges(orderId) {
            try {
                showLoading();
                
                // Form verilerini topla
                const status = document.getElementById('orderStatus').value;
                const isPaid = document.getElementById('isPaid').value === 'true';
                const paymentMethod = document.getElementById('paymentMethod').value;
                
                // Adres bilgileri
                const shippingAddress = {
                    address: document.getElementById('shippingAddress').value,
                    city: document.getElementById('shippingCity').value,
                    postalCode: document.getElementById('shippingPostalCode').value,
                    country: document.getElementById('shippingCountry').value
                };
                
                const billingAddress = {
                    address: document.getElementById('billingAddress').value,
                    city: document.getElementById('billingCity').value,
                    postalCode: document.getElementById('billingPostalCode').value,
                    country: document.getElementById('billingCountry').value
                };
                
                // Ücret bilgileri
                const taxPrice = parseFloat(document.getElementById('taxPrice').value) || 0;
                const shippingPrice = parseFloat(document.getElementById('shippingPrice').value) || 0;
                
                // Sipariş ürünleri
                const orderItems = [];
                const prices = document.querySelectorAll('.item-price');
                const quantities = document.querySelectorAll('.item-qty');
                
                for (let i = 0; i < prices.length; i++) {
                    const index = parseInt(prices[i].getAttribute('data-index'));
                    
                    orderItems[index] = {
                        price: parseFloat(prices[i].value),
                        qty: parseInt(quantities[i].value)
                    };
                }
                
                // API endpoint'i henüz yoksa uyarı göster
                showNotification('Sipariş güncelleme fonksiyonu henüz geliştirme aşamasında', 'warning');
                
                // API isteğini buraya ekleyeceksiniz
                /*
                await AdminAPI.updateOrder(orderId, {
                    status,
                    isPaid,
                    paymentMethod,
                    shippingAddress,
                    billingAddress,
                    taxPrice,
                    shippingPrice,
                    orderItems
                });
                */
                
                showNotification('Sipariş başarıyla güncellendi', 'success');
                
                setTimeout(() => {
                    window.location.href = 'orders.html';
                }, 2000);
                
            } catch (error) {
                console.error('Sipariş güncellenirken hata:', error);
                showNotification('Sipariş güncellenirken bir hata oluştu', 'error');
            } finally {
                hideLoading();
            }
        }
        
        // Sipariş düzenleme API fonksiyonunu admin-api.js'ye ekleyin
        /*
        AdminAPI.updateOrder = async function(id, data) {
            return AdminAPI.request(`/api/admin/orders/${id}`, 'PUT', data);
        };
        */
    </script>
</body>
</html> 